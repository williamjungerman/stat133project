---
title: "central_file"
author: ""
date: ""
output: 
  html_document:
    fig_height: 3
    fig_width: 5
---
<!-- Don't edit in between this line and the one below -->
```{r include=FALSE}
# Don't delete this chunk if you are using the DataComputing package
library(DataComputing)
library(tidyr)
library(XML)
library(RJSONIO)
library(sp)
library(rworldmap)
library(maps)
library(mapdata)
library(gridExtra)
```

*Source file* 
```{r, results='asis', echo=FALSE}
includeSourceDocuments()
```

Continent Function adopted from Stack Overflow: http://stackoverflow.com/questions/17768160/is-there-a-way-in-r-to-tell-what-continent-a-certain-lat-long-coordinate-belongs


```{r}
meteorite <- read.csv("~/Downloads/meteorite-landings.csv")
```

take out 0 longitude/latitudes; year stuff
```{r}
meteorite <- meteorite %>% 
  filter(reclat != 0 & reclong != 0) %>%
  filter(year>=860 & year<=2016) %>%
  filter(recclass != "Unknown") %>%
  mutate(count = 1)
```

Replacing mass na's with the medians of the same meteorite types
```{r}
replace_mass_na <- function(index, class) {
  same_classes <- meteorite$recclass[meteorite$recclass == class]
  masses <- meteorite$mass[same_classes]
  return(median(masses))
}

for (count in 1:nrow(meteorite)) {
  if (is.na(meteorite[count, "mass"])) {
    class <- meteorite[count, "recclass"]
    meteorite[count, "mass"] <- replace_mass_na(count, meteorite[count, "recclass"])
  } 
}
```

Add region and country columns
```{r}
coords <- data.frame('Long' = meteorite$reclong, 'Lat' = meteorite$reclat)

coords2region = function(points){ # where points is a df taking longitude as a first column and latitude as a second
  countriesSP <- getMap(resolution='low')
  pointsSP = SpatialPoints(points, proj4string=CRS(proj4string(countriesSP)))
  indices = over(pointsSP, countriesSP)
  indices$REGION
  }

coords2country = function(points){
  countriesSP <- getMap(resolution='low')
  pointsSP = SpatialPoints(points, proj4string=CRS(proj4string(countriesSP)))
  indices = over(pointsSP, countriesSP)
  indices$ADMIN
  }

meteorite$region <- coords2region(coords)
meteorite$country <- coords2country(coords)
```

Our custom theme
```{r}
theme_project <- theme(axis.ticks.y = element_blank(),
panel.background = element_rect(fill = "royalblue2"), plot.background = element_rect(fill = "lightblue"), panel.grid.major = element_line(color = "lightgoldenrod1", size=.2), panel.grid.minor = element_line(color = "lightgoldenrod1", size=.2), panel.grid.major.x=element_blank())
```

Global data frames
```{r}
fell_found_yearly <- meteorite %>%
  filter(year >= 1500) %>%
  group_by(year,fall) %>%
  summarise(count = n())

total_per_year_df<-meteorite %>%
  filter(year>1800) %>% 
  group_by(year) %>%
  summarise(total_by_year=n()) 

top_types<- meteorite %>%
  group_by(recclass) %>%
  summarise(top_meteorites= n()) %>%
  arrange(desc(top_meteorites)) %>%
  head(5)

top_type_meteorite <- meteorite %>%
  group_by(recclass) %>%
  filter(recclass %in% top_types$recclass) %>%
  group_by(recclass, region) %>%
  summarise(total_per_continent=n())

meteorite_map <- meteorite %>% 
  filter(reclong < 200)
```

Found/Total Ratio Per Year
```{r}
total_per_year_df %>%
  filter(year >= 1800) %>% 
  left_join(meteorite %>%
    filter(fall=="Found") %>%
    group_by(year) %>%
    summarise(found_by_year=n())) %>%
  mutate(ratio= ifelse(is.na(found_by_year), 0, found_by_year/total_by_year)) %>%
  ggplot(aes(x=year, y= ratio)) + geom_smooth(method="loess", se=FALSE, colour = "blue") +geom_point() + geom_smooth(method="lm", se=FALSE, colour = "gold") + labs(y = "Ratio of Found/Total per year", x = "Year")

```

Fell vs Found Density Over the Years
```{r}
fell_found_yearly %>%
  ggplot(aes(x = year)) + geom_density(aes(fill = fall), alpha = 0.8) + labs(x = "Year",y = "Density") +  scale_fill_manual("Fall Type",values=c("blue","gold"))
```

Density of Fell and Found Over the Years
```{r}
meteorite %>%
  filter(year >1800) %>%
  ggplot(aes(x=year)) + geom_density(aes(fill = fall), alpha =0.8) + facet_grid(~fall) + labs(x = "Year", y = "Density")  + scale_fill_manual("Fall Type",values=c("blue", "gold")) 
```

Fall Value Count Per Year
```{r fig.width = 9}
plot1 <- meteorite %>%
  filter(year > 1800 & fall=="Found") %>%
  group_by(year) %>%
  summarise(Found_By_Year=log(n())) %>%
  left_join(meteorite %>%
    filter(year > 1800 & fall=="Fell") %>%
    group_by(year) %>%
    summarise(Fell_by_year=log(n()))) %>%
  ggplot(aes(x=year)) +
  geom_line(aes(y = Found_By_Year, colour = "Found_By_Year")) + 
  geom_line(aes(y = Fell_by_year, colour = "Fell_by_year")) +
  labs(title="Meteorites Found Per Year", y = "Number of 'Fell/Found' meteorites", x = "Year")

plot2 <- meteorite %>%
  filter(year > 1800 & fall=="Found") %>%
  group_by(year) %>%
  summarise(Found_By_Year=log(n())) %>%
  left_join(meteorite %>%
    filter(year > 1800 & fall=="Fell") %>%
    group_by(year) %>%
    summarise(Fell_by_year=log(n()))) %>%
  ggplot(aes(x=year)) +
  geom_smooth(aes(y = Found_By_Year, colour = "Found_By_Year")) + 
  geom_smooth(aes(y = Fell_by_year, colour = "Fell_by_year")) +
  labs(title="Meteorites Found Per Year", y = "Number of 'Fell/Found' meteorites", x = "Year")

grid.arrange(plot1, plot2, ncol=2)
```


```{r warning=FALSE}

ggplot(meteorite, aes(x = fall, y = log(mass))) + 
  geom_boxplot(aes(fill = fall), alpha = 0.8) +
  labs(x = "Fall", y = "Log(Mass)", title = paste("Fell vs Found log(Mass)")) +
  theme(legend.position = "none") +
 scale_fill_manual(values=c("blue", "gold"))

```

Visualization of Found vs Fell by year 
```{r fig.height = 8, fig.width = 8}
#Use package mapdata which works well with ggplot, explain coord_fixed, geom_polygon

world <- map_data("world")
ggplot() + geom_polygon(data = world, aes(x=long, y = lat, group = group)) + geom_point(data = meteorite_map, aes(x=reclong, y=reclat,color = fall), size = 0.02, alpha = 0.3) + coord_fixed(1.2) + facet_grid(~ fall) + theme_classic() + theme(axis.title = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.text  = element_blank(), legend.position = "none") 
```


```{r}
meteorite %>%
  filter(year>1800) %>%
  filter(!is.na(region)) %>%
  group_by(year, region, fall) %>%
  summarise(count = log(n())) %>%
ggplot(aes(x=year, y=count)) + 
  geom_line(aes(color = fall)) +
  facet_wrap(~ region) + 
  labs(title=paste("Number of Found/Fell meteorites per year by continent"), x = "Year", y = "Count") 

```


```{r}
# not included for now, not sure what it shows 

world <- map_data("world")
ggplot() + geom_polygon(data = world, aes(x=long, y = lat, group = group)) + geom_point(data = meteorite_map %>% filter(recclass %in% top_types$recclass), aes(x=reclong, y=reclat,color = recclass), size = 0.02, alpha = 0.3) + coord_fixed(1.2) + theme_classic() + theme(axis.title = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.text  = element_blank(), legend.position = "none")
```











